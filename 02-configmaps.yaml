---
apiVersion: v1
kind: ConfigMap
metadata:
  name: db-init-script
  namespace: ecommerce
data:
  init.sql: |
    -- init.sql

    CREATE TABLE IF NOT EXISTS products (
        id SERIAL PRIMARY KEY,
        name VARCHAR(100) NOT NULL,
        price DECIMAL(10,2) NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    GRANT ALL PRIVILEGES ON TABLE products TO CURRENT_USER;

    -- Insert sample data
    INSERT INTO products (name, price) VALUES
        ('Laptop', 999.99),
        ('Smartphone', 699.99),
        ('Headphones', 149.99),
        ('Tablet', 399.99),
        ('Smart Watch', 199.99)
    ON CONFLICT DO NOTHING;
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: ecommerce
data:
  default.conf: |
    # Main server block
    server {
        listen 80;
        server_name _;

        # Security headers
        add_header X-Content-Type-Options nosniff;
        add_header X-Frame-Options DENY;
        add_header X-XSS-Protection "1; mode=block";

        root /usr/share/nginx/html;
        index index.html;

        # Proxy API calls to Flask
        location ~ ^/(products|health) {
            proxy_pass http://app:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }
    }
  nginx.conf: |
    user  nginx;
    worker_processes  auto;

    error_log  /var/log/nginx/error.log notice;
    pid        /var/run/nginx.pid;

    events {
        worker_connections  1024;
    }

    http {
        include       /etc/nginx/mime.types;
        default_type  application/octet-stream;

        log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                          '$status $body_bytes_sent "$http_referer" '
                          '"$http_user_agent" "$http_x_forwarded_for"';

        access_log  /var/log/nginx/access.log  main;

        sendfile        on;
        keepalive_timeout  65;

        include /etc/nginx/conf.d/*.conf;
    }
  index.html: |
    <!DOCTYPE html>
    <html>
    <head>
        <title>DevOps E-commerce Store</title>
        <style>
            body { font-family: Arial, sans-serif; margin: 40px; }
            .product { border: 1px solid #ddd; padding: 20px; margin: 10px; border-radius: 5px; }
            .info { background: #f0f8ff; padding: 15px; margin: 15px 0; border-radius: 5px; }
            .status { padding: 10px; margin: 10px 0; border-radius: 3px; }
            .healthy { background: #d4edda; color: #155724; }
            button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        </style>
    </head>
    <body>
        <div class="info">
            <h2>Automatic Deployment - E-commerce Stack</h2>
            <p>This application was deployed automatically using Kubernetes</p>
            <div id="health-status" class="status"></div>
        </div>

        <h1>Products</h1>

        <div>
            <h3 id="formTitle">Add New Product</h3>
            <input type="hidden" id="productId">
            <input type="text" id="productName" placeholder="Product name">
            <input type="number" id="productPrice" placeholder="Price" step="0.01">
            <button id="submitButton" onclick="submitProduct()">Add Product</button>
            <button id="cancelButton" onclick="cancelEdit()" style="display:none;">Cancel</button>
        </div>

        <div id="products"></div>

        <script>
            // Check health status
            fetch('/health')
                .then(response => response.json())
                .then(data => {
                    const healthDiv = document.getElementById('health-status');
                    healthDiv.className = 'status healthy';
                    healthDiv.innerHTML = `
                        <strong>Status:</strong> ${data.status} |
                        <strong>Database:</strong> ${data.database} |
                        <strong>Redis:</strong> ${data.redis} |
                        <strong>Nginx:</strong> ${data.nginx}
                    `;
                });

            // Load products
            function loadProducts() {
                fetch('/products')
                    .then(response => response.json())
                    .then(data => {
                        const container = document.getElementById('products');
                        container.innerHTML = `<p><strong>Data source:</strong> ${data.source}</p>`;

                        data.data.forEach(product => {
                            const div = document.createElement('div');
                            div.className = 'product';
                            div.innerHTML = `
                                <h3>${product.name}</h3>
                                <p>Price: $${product.price}</p>
                                <button onclick="editProduct(${product.id}, '${product.name}', ${product.price})">Edit</button>
                                <button onclick="deleteProduct(${product.id})">Delete</button>
                            `;
                            container.appendChild(div);
                        });
                    });
            }

            // Submit product (add or update)
            function submitProduct() {
                const id = document.getElementById('productId').value;
                const name = document.getElementById('productName').value;
                const price = document.getElementById('productPrice').value;

                const method = id ? 'PUT' : 'POST';
                const url = id ? `/products/${id}` : '/products';

                fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name, price })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                    } else {
                        alert(id ? 'Product updated!' : 'Product added!');
                        cancelEdit();
                        loadProducts(); // Reload products
                    }
                });
            }

            // Edit product
            function editProduct(id, name, price) {
                document.getElementById('productId').value = id;
                document.getElementById('productName').value = name;
                document.getElementById('productPrice').value = price;
                document.getElementById('formTitle').textContent = 'Edit Product';
                document.getElementById('submitButton').textContent = 'Update Product';
                document.getElementById('cancelButton').style.display = 'inline';
            }

            // Delete product
            function deleteProduct(id) {
                if (confirm('Are you sure you want to delete this product?')) {
                    fetch(`/products/${id}`, {
                        method: 'DELETE'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert('Error: ' + data.error);
                        } else {
                            alert('Product deleted!');
                            loadProducts(); // Reload products
                        }
                    });
                }
            }

            // Cancel edit
            function cancelEdit() {
                document.getElementById('productId').value = '';
                document.getElementById('productName').value = '';
                document.getElementById('productPrice').value = '';
                document.getElementById('formTitle').textContent = 'Add New Product';
                document.getElementById('submitButton').textContent = 'Add Product';
                document.getElementById('cancelButton').style.display = 'none';
            }

            // Initial load
            loadProducts();
        </script>
    </body>
    </html>
